## Exercise Unit: Automate Bicep Module Publishing with GitHub Actions and Azure CLI

**Learning Objective:**
- Learners will be able to create, configure, and automate the publishing process of Bicep modules into a container registry using BICEP, GitHub Actions, and Azure CLI.

**Scenario:**
- You are a DevOps engineer at a company that uses Azure for managing its infrastructure. The company recently decided to automate the process of publishing Bicep modules into a container registry to streamline deployments and ensure consistency. Your task is to create a workflow that handles this publishing process using Azure CLI, GitHub Actions, and Bicep.

### Task 1: Set up the Environment
1. **Install Necessary Tools**
   1. Install **Azure CLI**: Follow the [official installation guide](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli).
   2. Install **Bicep CLI**: Follow the [installation instructions](https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/install).
   3. Install **GitHub CLI**: Follow the [installation guide](https://cli.github.com/manual/installation).

2. **Create an Azure Container Registry (ACR)**
   1. Open your terminal.
   2. Run the following command to create a resource group:
      ```sh
      az group create --name exampleRG --location westus
      ```
   3. Create a container registry within the resource group:
      ```sh
      az acr create --resource-group exampleRG --name exampleregistry --sku Basic
      ```

### Task 2: Create a Service Principal and Configure GitHub Secrets
1. **Create a Service Principal**
   1. Run the following command to create a service principal and assign the "Contributor" role:
      ```sh
      az ad sp create-for-rbac --name myApp --role contributor --scopes /subscriptions/{subscription-id}/resourceGroups/exampleRG --sdk-auth
      ```
   2. Note the JSON output containing the `clientId`, `clientSecret`, `subscriptionId`, and `tenantId`.

2. **Configure GitHub Secrets for Authentication**
   1. Go to your GitHub repository.
   2. Navigate to `Settings > Secrets and variables > Actions > New repository secret`.
   3. Add the following secrets:
      - `AZURE_CREDENTIALS`: Paste the entire JSON output from the Azure CLI command.
      - `AZURE_RG`: Set this to `exampleRG`.
      - `AZURE_SUBSCRIPTION`: Set this to your subscription ID from the JSON output.

### Task 3: Add a Bicep File to Your GitHub Repository
1. **Create a Bicep File**
   1. In your GitHub repository, create a new file named `main.bicep`.
   2. Add the following content to define a storage account:
      ```bicep
      @minLength(3)
      @maxLength(11)
      param storagePrefix string
      @allowed([
        'Standard_LRS'
        'Standard_GRS'
        'Standard_RAGRS'
        'Standard_ZRS'
        'Premium_LRS'
        'Premium_ZRS'
        'Standard_GZRS'
        'Standard_RAGZRS'
      ])
      param storageSKU string = 'Standard_LRS'
      param location string = resourceGroup().location

      var uniqueStorageName = '${storagePrefix}${uniqueString(resourceGroup().id)}'

      resource stg 'Microsoft.Storage/storageAccounts@2023-04-01' = {
        name: uniqueStorageName
        location: location
        sku: {
          name: storageSKU
        }
        kind: 'StorageV2'
        properties: {
          supportsHttpsTrafficOnly: true
        }
      }

      output storageEndpoint object = stg.properties.primaryEndpoints
      ```
   3. Commit the file to the repository.

### Task 4: Create a GitHub Actions Workflow
1. **Create a Workflow File**
   1. In your GitHub repository, navigate to `.github/workflows/`.
   2. Create a new file named `deployBicepFile.yml`.
   3. Add the following content to automate the deployment:
      ```yaml
      name: Deploy Bicep file
      on: [push]
      jobs:
        build-and-deploy:
          runs-on: ubuntu-latest
          steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Log into Azure
              uses: azure/login@v1
              with:
                creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Deploy Bicep file
              uses: azure/arm-deploy@v1
              with:
                subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
                resourceGroupName: ${{ secrets.AZURE_RG }}
                template: ./main.bicep
                parameters: 'storagePrefix=mystore storageSKU=Standard_LRS'
                failOnStdErr: false
      ```
   4. Commit the file to the repository.

### Task 5: Verify the Workflow
1. **Trigger the Workflow**
   - Push a change to the repository (e.g., edit the `main.bicep` file).
   
2. **Check Workflow Status**
   1. Go to the `Actions` tab in your GitHub repository.
   2. Select the workflow that was triggered.
   3. Verify that the status is `Success`.

### Task 6: Clean up Resources
1. **Delete the Resource Group**
   1. Run the following command to delete the resource group:
      ```sh
      az group delete --name exampleRG
      ```
2. **Delete the GitHub Repository (Optional)**
   1. Navigate to `Settings` in your GitHub repository.
   2. Scroll down to the `Danger Zone` section.
   3. Click on `Delete this repository`.

**Practical Tasks:**
1. Create a new Bicep file in your repository that defines a different Azure resource, such as an App Service.
2. Modify the GitHub Actions workflow to deploy the new Bicep file.

**Checkpoints:**
1. **Question:** What is the purpose of creating a service principal?
   - **Answer:** A service principal is used for authentication and authorization in Azure, allowing GitHub Actions to deploy resources securely.
2. **Task:** Verify that the storage account created by the Bicep file is listed in the Azure portal.

**Additional Resources:**
- [Deploy Bicep files by using GitHub Actions](https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/deploy-github-actions)
- [Publish Bicep modules to private module registry](https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/quickstart-private-module-registry)
- [Azure CLI Documentation](https://docs.microsoft.com/en-us/cli/azure/)

**Key Takeaways:**
- Setting up the environment involves installing necessary tools and creating an Azure container registry.
- Authentication is configured through a service principal and GitHub secrets.
- Bicep files define Azure resources and can be stored in GitHub repositories.
- GitHub Actions workflows automate the deployment of Bicep files to Azure.
- Verification and cleanup are essential steps in maintaining a clean and functional environment.
